name: build and integrate image to dockerhub
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: checkout repository
        uses: actions/checkout@v3

      - name: Login to dockerhub
        uses: docker/login-action@v2
        with:
          username: ricardo403
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: build and push docker image
        run: |
          # On utilise une variable unique pour éviter les erreurs de frappe
          IMAGE_FULL_NAME="ricardo403/my_python_web_app:latest"
          docker build -t $IMAGE_FULL_NAME .
          docker push $IMAGE_FULL_NAME

      - name: Deploy locally on VM
        run: |
          echo "Début du déploiement local..."
          
          # Configuration identique au build
          FULL_IMAGE="ricardo403/my_python_web_app:latest"
          CONTAINER_NAME="flask-app"
          NETWORK_NAME="flask-network"

          log_info() { echo "[INFO] $1"; }
          log_error() { echo "[ERROR] $1"; }
          log_success() { echo "[SUCCESS] $1"; }

          # Correction : sudo peut être nécessaire selon la config de la VM
          mkdir -p /opt/flask-app 2>/dev/null || true

          log_info "Pull de l'image $FULL_IMAGE..."
          docker pull $FULL_IMAGE

          log_info "Nettoyage de l'ancien conteneur..."
          docker stop $CONTAINER_NAME 2>/dev/null || true
          docker rm $CONTAINER_NAME 2>/dev/null || true

          log_info "Vérification du réseau..."
          docker network create $NETWORK_NAME 2>/dev/null || true

          log_info "Démarrage du conteneur..."
          docker run -d \
            --name $CONTAINER_NAME \
            --restart unless-stopped \
            --network $NETWORK_NAME \
            -p 5000:5000 \
            -e SECRET_KEY="${{ secrets.APP_SECRET_KEY }}" \
            -e FLASK_ENV=production \
            $FULL_IMAGE

          sleep 5

          if docker ps | grep -q $CONTAINER_NAME; then
            log_success "Conteneur démarré avec succès"
          else
            log_error "Échec du démarrage"
            docker logs $CONTAINER_NAME
            exit 1
          fi

          log_info "Nettoyage des images orphelines..."
          docker image prune -f
          
          echo "Déployé le $(date) - Commit: ${{ github.sha }}" >> /opt/flask-app/deployment.log