name: build and integrate image to dockerhub

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ricardo403
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push docker image
        run: |
          IMAGE_FULL_NAME="ricardo403/my_python_web_app:latest"
          # Construction de l'image
          docker build -t $IMAGE_FULL_NAME .
          # Envoi vers le registre
          docker push $IMAGE_FULL_NAME

      - name: Deploy locally on VM
        run: |
          set -eux  # affiche chaque commande et quitte en cas d'erreur
          echo "### Début du déploiement local ###"
          
          # Variables de configuration
          FULL_IMAGE="ricardo403/my_python_web_app:latest"
          CONTAINER_NAME="flask-app"
          NETWORK_NAME="flask-network"

          # Vérification de la valeur (affiche les octets pour détecter CR/LF)
          echo "[DEBUG] FULL_IMAGE='${FULL_IMAGE}'" | od -An -tx1

          # 1. Récupérer la dernière version de l'image
          echo "[INFO] Pull de l'image $FULL_IMAGE..."
          docker pull "$FULL_IMAGE"

          # 2. Arrêt et suppression sécurisée de l'ancien conteneur
          # On vérifie s'il existe pour éviter une erreur "No such container"
          if [ "$(docker ps -aq -f name=$CONTAINER_NAME)" ]; then
              echo "[INFO] Arrêt et suppression de l'ancien conteneur..."
              docker stop $CONTAINER_NAME
              docker rm $CONTAINER_NAME
          fi

          # 3. Vérification/Création du réseau
          docker network create $NETWORK_NAME 2>/dev/null || true

          # 4. Lancement du nouveau conteneur
          echo "[INFO] Démarrage du conteneur..."
          docker run -d \
            --name $CONTAINER_NAME \
            --restart unless-stopped \
            --network $NETWORK_NAME \
            -p 5000:5000 \
            -e SECRET_KEY="${{ secrets.APP_SECRET_KEY }}" \
            -e FLASK_ENV=production \
            $FULL_IMAGE

          # 5. Vérification de l'état de santé (Healthcheck simplifié)
          sleep 5
          if docker ps -f name=$CONTAINER_NAME --format "{{.Status}}" | grep -q "Up"; then
            echo "[SUCCESS] Conteneur déployé et en cours d'exécution."
          else
            echo "[ERROR] Le conteneur a échoué au démarrage."
            docker logs $CONTAINER_NAME
            exit 1
          fi

          # 6. Nettoyage des images inutilisées (libère de l'espace sur la VM)
          echo "[INFO] Nettoyage des images orphelines..."
          docker image prune -f
          
          # 7. Journalisation du déploiement (Utilisation du dossier personnel pour éviter les soucis de droits root)
          mkdir -p ~/deploy_logs
          echo "Déployé le $(date) - Commit: ${{ github.sha }}" >> ~/deploy_logs/deployment.log